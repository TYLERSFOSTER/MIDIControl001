
# Phase III Engineering Continuity Report  
**Project:** MIDIControl001  
**Prepared for:** Tyler Foster  
**Date:** _Autogenerated_  

---

# I. PURPOSE OF THIS DOCUMENT

This report provides a complete engineering continuity handoff for **Phase III** of the project.  
It combines:

- A **precise snapshot** of the plugin’s current architecture (as of Phase II – A7)
- A **formal verification** that architecture and tests match the intended design
- The **Phase III design plan** for voice modes, including extensible architecture for VoiceA, VoiceB, and VoiceLET
- Detailed engineering guidelines and risk analysis
- Explicit rules that future collaborators must follow  

This is enough for any new engineer (LLM or human) to continue the project without guesswork.

---

# II. PROJECT STATUS AT PHASE II – A7

## A. High-level Summary

As of Phase II A7:

- The entire project compiles and passes **30/30 tests**
- No DSP behavior has changed  
- The new **voiceMode** parameter is fully plumbed through:
  - APVTS
  - ParameterSnapshot
  - PluginProcessor
  - VoiceManager (stored but unused)
- Encapsulation is **preserved**
- VoiceA remains the only actual voice implementation in use

This is a **stable baseline** for introducing additional modes.

---

# III. ARCHITECTURE SNAPSHOT

## A. Layering Model (Canonical)

```
[Host / UI] 
      ↓ APVTS
[Parameter Layout / IDs]
      ↓ (raw float values)
[ParameterSnapshot]
      ↓
[PluginProcessor]
      ↓
[VoiceManager]
      ↓
[BaseVoice] ←→ VoiceA (current)
```

### Status: All layers intact.

---

# IV. DETAILED COMPONENT STATE

This section describes the exact state of each subsystem relevant to Phase III.

---

## A. Parameter System (APVTS)

### Files:
- `Source/params/ParameterIDs.h`
- `Source/params/ParamLayout.cpp`

### Current Parameters:
- masterVolume
- masterMix  
- **voiceMode** (Phase II)
- oscFreq  
- envAttack  
- envRelease  
- scope GUI parameters

### Verified:
- All parameters load default values
- All parameters roundtrip through APVTS
- voiceMode is declared via `AudioParameterChoice { "voiceA" }`
- Default index is 0

### Architectural Note:
voiceMode is currently forced to exactly **one choice** (“voiceA”).  
That is correct for Phase II.

---

## B. ParameterSnapshot

### Files:
- `Source/params/ParameterSnapshot.h`

Snapshot includes:

```
float masterVolumeDb
float masterMix
int   voiceMode   // new
float oscFreq
float envAttack
float envRelease
std::array<VoiceParams, NUM_VOICES>
```

### Verified in tests:
- Default values correct  
- Snapshot copy/assignment works  
- Snapshot is populated by PluginProcessor for every block  
- voiceMode copies correctly from APVTS → snapshot → VoiceManager

---

## C. PluginProcessor

### Files:
- `Source/plugin/PluginProcessor.h`
- `Source/plugin/PluginProcessor.cpp`

### Key mechanisms:
- `apvts` constructed with ParameterLayout  
- `makeSnapshotFromParams()` gathers all parameters  
- Every `processBlock()`:
  - rebuilds snapshot
  - pushes snapshot.voiceMode into VoiceManager
  - calls `voiceManager_.startBlock()`

### Verified in tests:
- Processor does not throw when mode changes
- VoiceManager receives correct snapshot
- Voices render and stop correctly  
- Parameter state save/restore works

---

## D. VoiceManager

### File:
- `Source/dsp/VoiceManager.h`

### Current functionality:
- Holds an array of `std::unique_ptr<BaseVoice>`
- Instantiates **VoiceA only**
- Performs polyphony, note-on, note-off, stealing
- Holds `int mode_ = 0`  
- Provides:

```
void setMode(int m)
int getMode() const noexcept
```

### Verified:
- Polyphony tests pass  
- Voice stealing tests pass  
- Basic DSP tests pass  
- mode_ is currently **inert** (not used to select different voices)

---

## E. VoiceA and BaseVoice

Your dump confirmed:

- VoiceA has:
  - OscillatorA
  - EnvelopeA
  - persistent CC5 detune
  - proper noteOn lifecycle
  - proper render loop
  - auto-deactivation  
  - updateParams() for attack/release
  - handleController() for CC3–5

### Verified by tests:
- Frequency behaviors  
- CC3–5 modulation  
- Diagnostic RMS/peak  
- Legacy equivalence  
- Scalecheck  
- Controller mapping  

VoiceA is stable and mature.

---

# V. TEST SUITE COVERAGE SUMMARY

All 30 tests passed.

### Coverage buckets:

1. **DSP primitives** (OscillatorA, EnvelopeA, MixNormalizer, PeakGuard)
2. **Voice engine** (VoiceA, VoiceManager)
3. **Integration** (PluginProcessor)
4. **Snapshot/Params** (ParameterSnapshot, APVTS load/roundtrip)
5. **Regression** (Legacy equivalence)

### Newly added:
- test_voice_mode_param.cpp  
Fully passing.

---

# VI. RISKS & FAILURE ANALYSIS

## A. Key insights from Phase II failures

The earlier failures stemmed from:

### 1. Tests accessing private internals  
Violates architecture and created instability.

### 2. Incorrect assumptions about layering  
VoiceManager should never be poked directly by tests.

### 3. Structural changes without synchronized testing  
Introducing new plumbing requires immediate test coverage.

### 4. Missing continuous “reality checks”  
Every change must be grounded in:
- real files  
- real diffs  
- real test outcomes  

This is now fixed.

---

# VII. PHASE III OBJECTIVES

Phase III is about transforming **voiceMode** from inert → meaningful.

The goal:  
**Introduce multiple “voice types” and a unified mode-switch architecture without destabilizing VoiceA.**

---

# VIII. PHASE III SUB-PHASES (CANONICAL)

Each can be run independently using your Prime Directive rules.

---

## **B3 (FIRST): Voice Modes Design Doc**  
_(Generated as a separate file but summarized here as well.)_

Defines:

- VoiceMode enum  
- Behavior of each mode  
- Requirements for VoiceB  
- Requirements for VoiceLET  
- Plugin-level architecture  
- DSP requirements (for VoiceLET, Doppler, retarded time, etc.)

(Full doc appears in the separate file.)

---

## **B1: Introduce Type-Safe Mode Enum**

Replace raw integer:

```
int voiceMode;
```

with:

```
enum class VoiceMode { VoiceA = 0, VoiceB = 1, VoiceLET = 2 };
```

Then:

- Snapshots continue storing an `int`
- VoiceManager internally stores `VoiceMode`
- Add `setModeFromInt(int)` ensuring clamping/validity
- Update tests accordingly  
(No DSP changes allowed)

---

## **B2: Mode Switch Hook Inside VoiceManager**

Introduce:

```
void VoiceManager::applyModeConfiguration();
```

Called from `startBlock()`.

Initially:

```
switch (mode_) {
    case VoiceMode::VoiceA:
    default:
        // no-op (current behavior)
        break;
}
```

This creates the “branching location” for future modes.

No voice instantiation changes yet.

---

## **B3: Full Design Doc for VoiceB and VoiceLET**  
_(Generated separately.)_

VoiceB:
- Alternate envelope or oscillator
- Different timbre
- Local behavior only (no Doppler)

VoiceLET:
- Entirely different DSP topology (relativistic Doppler)
- Likely uses internal velocity state, time dilation, retarded time calculation

---

# IX. WHAT NEXT ENGINEER MUST KNOW

### 1. VoiceA behavior must remain untouched  
All tests depend on exact VoiceA behavior.

### 2. All new modes must plug into VoiceManager, not replace it  
VoiceManager is the switching point.

### 3. Snapshot is the authoritative, single source of truth  
Never pull APVTS values inside voices.

### 4. Mode switching is per-block, not per-note  
This is intentional and avoids weird state divergence.

### 5. VoiceLET will require additional parameters  
But must not disturb VoiceA.

### 6. Tests must be added every time architecture expands  
Not after: during.

---

# X. RECOMMENDED FILE STRUCTURE FOR PHASE III

```
Source/dsp/voices/
    VoiceA.{h,cpp}
    VoiceB.{h,cpp}
    VoiceLET.{h,cpp}

Source/dsp/
    BaseVoice.h
    VoiceManager.h
    VoiceManager.cpp
    VoiceModes.h

Source/params/
    ParameterIDs.h
    ParamLayout.cpp
    ParameterSnapshot.h
```

---

# XI. TAGGING & VERSIONING GUIDELINES

Every stable checkpoint should be tagged exactly like:

```
git tag -a phase3-B1-mode-enum -m "Phase III B1: Introduced VoiceMode enum"
git tag -a phase3-B2-modeswitch -m "Phase III B2: Mode switch hook"
git tag -a phase3-B3-design-doc -m "Phase III B3: Full voice mode architecture doc"
```

---

# XII. FINAL PHASE III SUMMARY

### ✔ All mode plumbing exists  
### ✔ Architecture is stable  
### ✔ Tests are complete  
### ✔ Everything compiles  
### ✔ VoiceA is mature and unchanged  
### ✔ Phase III can begin safely  

### You are now ready for:
- VoiceMode enums  
- Mode-switch hooks  
- VoiceB specification  
- VoiceLET (relativistic) design  
- Future DSP expansions  

This report ends Phase II and begins Phase III.

